# üìÑ Sistema de Pagos a Cuenta y Facturaci√≥n desde Presupuestos

**Fecha**: 16 de febrero de 2026  
**Estado**: PLANIFICACI√ìN  
**Tipo**: Nueva funcionalidad - Sistema de facturaci√≥n, pagos y abonos

---

## üìã RESUMEN EJECUTIVO

Este plan detalla la implementaci√≥n de un sistema completo de pagos a cuenta para presupuestos aprobados en MDR, que incluye:

1. **Parte de trabajo para t√©cnicos**: Documento log√≠stico sin precios ni informaci√≥n comercial
2. **Factura Proforma**: Documento id√©ntico al presupuesto pero con numeraci√≥n propia para pagos a cuenta del 100%
3. **Factura de Anticipo**: Factura normal por el importe del anticipo con referencia al presupuesto
4. **Factura Rectificativa/Abono**: Anulaci√≥n de facturas normales con motivo, numeraci√≥n propia e importes en negativo
5. **Sistema de tracking de pagos**: Nueva tabla para registrar todos los pagos recibidos

**Decisiones clave**:
- ‚úÖ Se registrar√°n todos los documentos en BD (no solo PDFs)
- ‚úÖ Nueva tabla `pago_presupuesto` para tracking de anticipos
- ‚úÖ Facturas proforma tendr√°n serie independiente (`FP2024/0001`)
- ‚úÖ **Abonos solo para facturas normales** (NO para facturas proforma)
- ‚úÖ Serie de abonos (`R2024/0001`) ya existe en tabla empresa
- ‚úÖ Parte de trabajo ocultar√°: precios, descuentos, totales y formas de pago
- ‚úÖ **Empresas ficticias vs reales**: Los presupuestos se hacen con empresa ficticia principal, pero **TODAS las facturas (proforma, anticipo, normal) SIEMPRE requieren empresa REAL** para validez fiscal
- üö´ **Restricci√≥n empresa**: Una vez emitida CUALQUIER factura (proforma, anticipo o normal), **NO se permite cambiar de empresa** en ese presupuesto

---

## 1Ô∏è‚É£ CAMBIOS EN BASE DE DATOS

### 1.1 Modificar tabla `empresa`

**Archivo**: `BD/migrations/20260216_add_factura_proforma.sql`

A√±adir campos para numeraci√≥n de facturas proforma:

```sql
ALTER TABLE empresa
ADD COLUMN serie_factura_proforma_empresa VARCHAR(10) DEFAULT 'FP' 
    COMMENT 'Serie para facturas proforma (ej: FP, PRO, FPR)' AFTER numero_actual_presupuesto_empresa,
ADD COLUMN numero_actual_factura_proforma_empresa INT UNSIGNED DEFAULT 0 
    COMMENT '√öltimo n√∫mero de factura proforma emitida' AFTER serie_factura_proforma_empresa;

-- Crear √≠ndice
CREATE INDEX idx_serie_fp ON empresa(serie_factura_proforma_empresa);
```

**Nota**: Los campos `serie_abono_empresa` y `numero_actual_abono_empresa` **ya existen** en la tabla empresa, no requieren modificaci√≥n.

### 1.2 Crear tabla `documento_presupuesto`

**Archivo**: `BD/migrations/20260216_create_documento_presupuesto.sql`

Nueva tabla para registrar todos los documentos generados a partir de presupuestos:

```sql
CREATE TABLE documento_presupuesto (
    -- Identificaci√≥n
    id_documento_ppto INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    id_presupuesto INT UNSIGNED NOT NULL COMMENT 'FK a presupuesto',
    id_version_presupuesto INT UNSIGNED COMMENT 'Versi√≥n del presupuesto usada',
    id_empresa INT UNSIGNED NOT NULL COMMENT 'Empresa emisora - DEBE SER REAL (no ficticia) para facturas',
    seleccion_manual_empresa_documento_ppto BOOLEAN DEFAULT FALSE COMMENT 'TRUE si empresa fue seleccionada manualmente (TODAS las facturas: proforma, anticipo, normal), FALSE si heredada del presupuesto (presupuesto, parte_trabajo)',
    
    -- Tipo de documento
    tipo_documento_ppto ENUM(
        'presupuesto',           -- PDF presupuesto original
        'parte_trabajo',         -- PDF para t√©cnicos
        'factura_proforma',      -- Factura proforma (100% presupuesto) - REQUIERE EMPRESA REAL
        'factura_anticipo',      -- Factura de anticipo (parcial) - REQUIERE EMPRESA REAL
        'factura_final',         -- Factura final - REQUIERE EMPRESA REAL
        'factura_rectificativa'  -- Abono/rectificativa - USA MISMA EMPRESA QUE FACTURA ORIGEN
    ) NOT NULL,
    
    -- Numeraci√≥n
    numero_documento_ppto VARCHAR(50) NOT NULL COMMENT 'N√∫mero generado (P2024-001, FP2024/001, F2024/001, R2024/001)',
    serie_documento_ppto VARCHAR(10) COMMENT 'Serie usada (P, FP, F, R)',
    
    -- Relaci√≥n con documento original (para abonos)
    id_documento_origen INT UNSIGNED COMMENT 'FK a documento_presupuesto (factura que se abona)',
    motivo_abono_documento_ppto VARCHAR(255) COMMENT 'Motivo del abono si tipo=factura_rectificativa',
    
    -- Importes (para facturas)
    subtotal_documento_ppto DECIMAL(10,2) DEFAULT NULL,
    total_iva_documento_ppto DECIMAL(10,2) DEFAULT NULL,
    total_documento_ppto DECIMAL(10,2) DEFAULT NULL COMMENT 'Negativo si es abono',
    
    -- Archivo PDF
    ruta_pdf_documento_ppto VARCHAR(255) COMMENT 'public/documentos/presupuestos/[id_ppto]/[tipo]_[numero].pdf',
    tamano_pdf_documento_ppto INT UNSIGNED COMMENT 'Tama√±o en bytes',
    
    -- Fechas
    fecha_emision_documento_ppto DATE NOT NULL,
    fecha_generacion_documento_ppto DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- Observaciones
    observaciones_documento_ppto TEXT,
    
    -- Auditor√≠a
    activo_documento_ppto BOOLEAN DEFAULT TRUE,
    created_at_documento_ppto TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at_documento_ppto TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- Foreign Keys
    CONSTRAINT fk_documento_presupuesto 
        FOREIGN KEY (id_presupuesto) 
        REFERENCES presupuesto(id_presupuesto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
        
    CONSTRAINT fk_documento_version 
        FOREIGN KEY (id_version_presupuesto) 
        REFERENCES presupuesto_version(id_version_presupuesto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
        
    CONSTRAINT fk_documento_empresa 
        FOREIGN KEY (id_empresa) 
        REFERENCES empresa(id_empresa)
        ON DELETE RESTRICT ON UPDATE CASCADE,
        
    CONSTRAINT fk_documento_origen 
        FOREIGN KEY (id_documento_origen) 
        REFERENCES documento_presupuesto(id_documento_ppto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    
    -- √çndices
    INDEX idx_presupuesto_doc (id_presupuesto),
    INDEX idx_tipo_doc (tipo_documento_ppto),
    INDEX idx_numero_doc (numero_documento_ppto),
    INDEX idx_fecha_emision (fecha_emision_documento_ppto),
    INDEX idx_activo_doc (activo_documento_ppto),
    INDEX idx_documento_origen (id_documento_origen),
    UNIQUE KEY uk_numero_tipo (numero_documento_ppto, tipo_documento_ppto)
    
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_spanish_ci
COMMENT='Documentos generados a partir de presupuestos (PDFs, facturas, partes trabajo, abonos)';
```

### 1.3 Crear tabla `pago_presupuesto`

**Archivo**: `BD/migrations/20260216_create_pago_presupuesto.sql`

Nueva tabla para registrar pagos a cuenta:

```sql
CREATE TABLE pago_presupuesto (
    -- Identificaci√≥n
    id_pago_ppto INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    id_presupuesto INT UNSIGNED NOT NULL COMMENT 'FK a presupuesto',
    id_documento_ppto INT UNSIGNED COMMENT 'FK a documento_presupuesto (factura relacionada)',
    
    -- Tipo de pago
    tipo_pago_ppto ENUM(
        'anticipo',        -- Pago a cuenta (parcial)
        'total',           -- Pago del 100% (con factura proforma)
        'resto',           -- Pago del saldo pendiente
        'devolucion'       -- Devoluci√≥n por abono
    ) NOT NULL,
    
    -- Importes
    importe_pago_ppto DECIMAL(10,2) NOT NULL COMMENT 'Importe del pago recibido (negativo si devolucion)',
    porcentaje_pago_ppto DECIMAL(5,2) COMMENT 'Porcentaje sobre total presupuesto',
    
    -- M√©todo de pago
    id_metodo_pago INT UNSIGNED COMMENT 'FK a metodo_pago',
    referencia_pago_ppto VARCHAR(100) COMMENT 'N√∫mero de transferencia, recibo, etc.',
    
    -- Fechas
    fecha_pago_ppto DATE NOT NULL COMMENT 'Fecha en que se recibi√≥ el pago',
    fecha_valor_pago_ppto DATE COMMENT 'Fecha valor bancario',
    
    -- Estado
    estado_pago_ppto ENUM(
        'pendiente',       -- Registrado pero no confirmado
        'recibido',        -- Pago recibido y confirmado
        'conciliado',      -- Conciliado en contabilidad
        'anulado'          -- Pago anulado (por abono)
    ) DEFAULT 'recibido',
    
    -- Observaciones
    observaciones_pago_ppto TEXT,
    
    -- Auditor√≠a
    activo_pago_ppto BOOLEAN DEFAULT TRUE,
    created_at_pago_ppto TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at_pago_ppto TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- Foreign Keys
    CONSTRAINT fk_pago_presupuesto 
        FOREIGN KEY (id_presupuesto) 
        REFERENCES presupuesto(id_presupuesto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
        
    CONSTRAINT fk_pago_documento 
        FOREIGN KEY (id_documento_ppto) 
        REFERENCES documento_presupuesto(id_documento_ppto)
        ON DELETE SET NULL ON UPDATE CASCADE,
        
    CONSTRAINT fk_pago_metodo 
        FOREIGN KEY (id_metodo_pago) 
        REFERENCES metodo_pago(id_metodo_pago)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    
    -- √çndices
    INDEX idx_presupuesto_pago (id_presupuesto),
    INDEX idx_tipo_pago (tipo_pago_ppto),
    INDEX idx_fecha_pago (fecha_pago_ppto),
    INDEX idx_estado_pago (estado_pago_ppto),
    INDEX idx_activo_pago (activo_pago_ppto)
    
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_spanish_ci
COMMENT='Registro de pagos a cuenta recibidos sobre presupuestos (incluye devoluciones por abonos)';
```

### 1.4 Actualizar Stored Procedure `sp_obtener_siguiente_numero`

**Archivo**: `BD/migrations/20260216_update_sp_obtener_siguiente_numero.sql`

A√±adir soporte para facturas proforma (el tipo 'abono' ya existe):

```sql
DROP PROCEDURE IF EXISTS sp_obtener_siguiente_numero$$

CREATE PROCEDURE sp_obtener_siguiente_numero(
    IN p_codigo_empresa VARCHAR(20),
    IN p_tipo_documento ENUM('presupuesto','factura','factura_proforma','abono'),
    OUT p_numero_completo VARCHAR(50)
)
BEGIN
    DECLARE v_serie VARCHAR(10);
    DECLARE v_numero_actual INT;
    DECLARE v_anio VARCHAR(4);
    
    SET v_anio = YEAR(CURDATE());
    
    IF p_tipo_documento = 'presupuesto' THEN
        SELECT serie_presupuesto_empresa,
               numero_actual_presupuesto_empresa + 1
        INTO v_serie, v_numero_actual
        FROM empresa
        WHERE codigo_empresa = p_codigo_empresa AND activo_empresa = TRUE;
        
        SET p_numero_completo = CONCAT(v_serie, v_anio, '-', LPAD(v_numero_actual, 4, '0'));
        
    ELSEIF p_tipo_documento = 'factura' THEN
        SELECT serie_factura_empresa,
               numero_actual_factura_empresa + 1
        INTO v_serie, v_numero_actual
        FROM empresa
        WHERE codigo_empresa = p_codigo_empresa AND activo_empresa = TRUE;
        
        SET p_numero_completo = CONCAT(v_serie, v_anio, '/', LPAD(v_numero_actual, 4, '0'));
        
    ELSEIF p_tipo_documento = 'factura_proforma' THEN
        SELECT serie_factura_proforma_empresa,
               numero_actual_factura_proforma_empresa + 1
        INTO v_serie, v_numero_actual
        FROM empresa
        WHERE codigo_empresa = p_codigo_empresa AND activo_empresa = TRUE;
        
        -- Formato: FP2024/0001
        SET p_numero_completo = CONCAT(v_serie, v_anio, '/', LPAD(v_numero_actual, 4, '0'));
        
    ELSEIF p_tipo_documento = 'abono' THEN
        SELECT serie_abono_empresa,
               numero_actual_abono_empresa + 1
        INTO v_serie, v_numero_actual
        FROM empresa
        WHERE codigo_empresa = p_codigo_empresa AND activo_empresa = TRUE;
        
        -- Formato: R2024/0001
        SET p_numero_completo = CONCAT(v_serie, v_anio, '/', LPAD(v_numero_actual, 4, '0'));
    END IF;
END$$
```

### 1.5 Actualizar Stored Procedure `sp_actualizar_contador_empresa`

**Archivo**: `BD/migrations/20260216_update_sp_actualizar_contador.sql`

```sql
DROP PROCEDURE IF EXISTS sp_actualizar_contador_empresa$$

CREATE PROCEDURE sp_actualizar_contador_empresa(
    IN p_id_empresa INT UNSIGNED,
    IN p_tipo_documento ENUM('presupuesto','factura','factura_proforma','abono')
)
BEGIN
    IF p_tipo_documento = 'presupuesto' THEN
        UPDATE empresa 
        SET numero_actual_presupuesto_empresa = numero_actual_presupuesto_empresa + 1
        WHERE id_empresa = p_id_empresa;
        
    ELSEIF p_tipo_documento = 'factura' THEN
        UPDATE empresa 
        SET numero_actual_factura_empresa = numero_actual_factura_empresa + 1
        WHERE id_empresa = p_id_empresa;
        
    ELSEIF p_tipo_documento = 'factura_proforma' THEN
        UPDATE empresa 
        SET numero_actual_factura_proforma_empresa = numero_actual_factura_proforma_empresa + 1
        WHERE id_empresa = p_id_empresa;
        
    ELSEIF p_tipo_documento = 'abono' THEN
        UPDATE empresa 
        SET numero_actual_abono_empresa = numero_actual_abono_empresa + 1
        WHERE id_empresa = p_id_empresa;
    END IF;
END$$
```

### 1.6 Crear vista `v_documentos_presupuesto`

**Archivo**: `BD/migrations/20260216_create_vista_documentos.sql`

Vista para consultar documentos con informaci√≥n de origen (para abonos):

```sql
CREATE OR REPLACE VIEW v_documentos_presupuesto AS
SELECT 
    -- Documento actual
    dp.id_documento_ppto,
    dp.id_presupuesto,
    dp.id_version_presupuesto,
    dp.tipo_documento_ppto,
    dp.numero_documento_ppto,
    dp.serie_documento_ppto,
    dp.subtotal_documento_ppto,
    dp.total_iva_documento_ppto,
    dp.total_documento_ppto,
    dp.fecha_emision_documento_ppto,
    dp.ruta_pdf_documento_ppto,
    dp.motivo_abono_documento_ppto,
    dp.observaciones_documento_ppto,
    
    -- Presupuesto
    p.numero_presupuesto,
    p.nombre_evento_presupuesto,
    
    -- Cliente
    c.nombre_cliente,
    c.apellido_cliente,
    CONCAT(c.nombre_cliente, ' ', c.apellido_cliente) AS nombre_completo_cliente,
    
    -- Empresa emisora
    e.nombre_empresa,
    e.nif_empresa,
    
    -- Documento origen (para abonos)
    do.id_documento_ppto AS id_documento_origen,
    do.numero_documento_ppto AS numero_documento_origen,
    do.tipo_documento_ppto AS tipo_documento_origen,
    do.total_documento_ppto AS total_documento_origen,
    
    -- Auditor√≠a
    dp.created_at_documento_ppto,
    dp.updated_at_documento_ppto

FROM documento_presupuesto dp

INNER JOIN presupuesto p 
    ON dp.id_presupuesto = p.id_presupuesto

INNER JOIN cliente c 
    ON p.id_cliente = c.id_cliente

INNER JOIN empresa e 
    ON dp.id_empresa = e.id_empresa

LEFT JOIN documento_presupuesto do 
    ON dp.id_documento_origen = do.id_documento_ppto

WHERE dp.activo_documento_ppto = 1

ORDER BY dp.fecha_emision_documento_ppto DESC, dp.id_documento_ppto DESC;
```

### 1.7 Crear vista `v_pagos_presupuesto`

**Archivo**: `BD/migrations/20260216_create_vista_pagos.sql`

Vista para consultar pagos con informaci√≥n completa:

```sql
CREATE OR REPLACE VIEW v_pagos_presupuesto AS
SELECT 
    -- Pago
    pp.id_pago_ppto,
    pp.id_presupuesto,
    pp.tipo_pago_ppto,
    pp.importe_pago_ppto,
    pp.porcentaje_pago_ppto,
    pp.fecha_pago_ppto,
    pp.estado_pago_ppto,
    pp.referencia_pago_ppto,
    pp.observaciones_pago_ppto,
    
    -- Presupuesto
    p.numero_presupuesto,
    p.nombre_evento_presupuesto,
    p.fecha_presupuesto,
    
    -- Cliente
    c.nombre_cliente,
    c.apellido_cliente,
    CONCAT(c.nombre_cliente, ' ', c.apellido_cliente) AS nombre_completo_cliente,
    
    -- Documento relacionado (factura)
    dp.id_documento_ppto,
    dp.tipo_documento_ppto,
    dp.numero_documento_ppto,
    dp.total_documento_ppto,
    
    -- M√©todo de pago
    mp.nombre_metodo_pago,
    mp.codigo_metodo_pago,
    
    -- Auditor√≠a
    pp.created_at_pago_ppto,
    pp.updated_at_pago_ppto

FROM pago_presupuesto pp

INNER JOIN presupuesto p 
    ON pp.id_presupuesto = p.id_presupuesto

INNER JOIN cliente c 
    ON p.id_cliente = c.id_cliente

LEFT JOIN documento_presupuesto dp 
    ON pp.id_documento_ppto = dp.id_documento_ppto

LEFT JOIN metodo_pago mp 
    ON pp.id_metodo_pago = mp.id_metodo_pago

WHERE pp.activo_pago_ppto = 1

ORDER BY pp.fecha_pago_ppto DESC, pp.id_pago_ppto DESC;
```

---

## 2Ô∏è‚É£ MODELOS PHP

### 2.1 Nuevo modelo `DocumentoPresupuesto.php`

**Archivo**: `models/DocumentoPresupuesto.php`

M√©todos principales:
- `insert_documento($id_presupuesto, $tipo_documento, $id_empresa, $datos)`
- `get_documentos_presupuesto($id_presupuesto)`
- `get_documentoxid($id_documento)`
- `get_documento_por_tipo_presupuesto($id_presupuesto, $tipo_documento)`
- `generar_numero_documento($id_empresa, $tipo_documento)`
- `actualizar_ruta_pdf($id_documento, $ruta_pdf, $tamano)`
- `verificar_existe_factura_tipo($id_presupuesto, $tipo_documento)`
- `verificar_puede_abonar($id_documento)` - Valida si se puede abonar
- `get_factura_origen($id_documento_abono)` - Obtiene factura abonada
- `verificar_empresa_real($id_empresa)` - ‚≠ê NUEVO - Valida que empresa NO sea ficticia
- `obtener_empresa_factura_presupuesto($id_presupuesto)` - ‚≠ê NUEVO - Obtiene empresa de primera factura emitida (bloqueo cambio empresa)

### 2.2 Nuevo modelo `PagoPresupuesto.php`

**Archivo**: `models/PagoPresupuesto.php`

M√©todos principales:
- `insert_pago($id_presupuesto, $tipo_pago, $importe, $fecha, $datos)`
- `update_pago($id_pago, $datos)`
- `get_pagos_presupuesto($id_presupuesto)`
- `get_pagoxid($id_pago)`
- `get_total_pagado($id_presupuesto)`
- `get_saldo_pendiente($id_presupuesto)`
- `delete_pagoxid($id_pago)`
- `calcular_porcentaje_pago($id_presupuesto, $importe)`
- `anular_pago_por_abono($id_documento, $id_documento_abono, $motivo)` - Anula pago al generar abono
- `get_pago_vinculado_factura($id_documento)` - Obtiene pago de una factura

### 2.3 Modificar modelo `Empresas.php`

**Archivo**: `models/Empresas.php`

A√±adir m√©todos para facturas proforma (abonos ya tiene m√©todos):

```php
// M√©todo nuevo para factura proforma
public function obtener_siguiente_numero_factura_proforma($codigo_empresa)
// M√©todo nuevo para actualizar contador factura proforma
public function actualizar_contador_factura_proforma($id_empresa)

// Los m√©todos para abonos YA EXISTEN (reutilizar):
// - obtener_siguiente_numero_abono($codigo_empresa)
// - actualizar_contador_abono($id_empresa)
```

---

## 3Ô∏è‚É£ CONTROLLERS PHP

### 3.1 Nuevo controller `documento_presupuesto.php`

**Archivo**: `controller/documento_presupuesto.php`

Operaciones:
- `listar` - Documentos de un presupuesto
- `guardaryeditar` - Registrar nuevo documento (valida empresa real)
- `mostrar` - Obtener documento por ID
- `descargar_pdf` - Descargar PDF generado
- `listar_por_tipo` - Filtrar por tipo de documento
- `verificar_puede_abonar` - Validar si factura es abonable
- `verificar_empresa_disponible` - ‚≠ê NUEVO - Verifica si se puede cambiar empresa (devuelve empresa bloqueada si existe factura)

### 3.2 Nuevo controller `pago_presupuesto.php`

**Archivo**: `controller/pago_presupuesto.php`

Operaciones:
- `listar` - Pagos de un presupuesto
- `guardaryeditar` - Registrar/editar pago (**validar id_empresa si genera factura**)
- `mostrar` - Obtener pago por ID
- `desactivar` - Anular pago manualmente
- `calcular_saldo` - Obtener saldo pendiente
- `verificar_pago_completo` - Comprobar si est√° completamente pagado
- **`listar_empresas_facturacion`** ‚≠ê NUEVO - Lista empresas reales disponibles (usa SP `sp_listar_empresas_facturacion()`)

### 3.3 Nuevos controllers de impresi√≥n

#### 3.3.1 `impresion_parte_trabajo.php`

Genera PDF para t√©cnicos basado en `impresionpresupuesto_m1_es.php` pero:
- ‚ùå SIN precios unitarios
- ‚ùå SIN descuentos
- ‚ùå SIN subtotales/totales/IVA
- ‚ùå SIN bloque de formas de pago
- ‚úÖ CON observaciones de l√≠neas y generales
- ‚úÖ CON fechas montaje/desmontaje
- ‚úÖ CON ubicaciones
- ‚úÖ CON c√≥digos de art√≠culos

#### 3.3.2 `impresion_factura_proforma.php`

Genera PDF de factura proforma:
- ‚úÖ Literal: **"FACTURA PROFORMA"**
- ‚úÖ N√∫mero de documento: obtenido de `sp_obtener_siguiente_numero`
- ‚ùå SIN observaciones de l√≠neas
- ‚ùå SIN observaciones generales del pie
- ‚úÖ CON todos los precios, descuentos, totales
- ‚úÖ CON datos fiscales de la empresa emisora
- ‚úÖ Total = Total del presupuesto

#### 3.3.3 `impresion_factura_anticipo.php`

Genera factura de anticipo:
- ‚úÖ Literal: **"FACTURA"**
- ‚úÖ N√∫mero de documento: serie_factura_empresa
- ‚úÖ Cuerpo: **Solo una l√≠nea**: `"A cuenta del presupuesto [NUMERO_PRESUPUESTO]"`
- ‚úÖ Total (con IVA) = Importe del anticipo
- ‚úÖ Datos fiscales completos
- ‚ùå SIN l√≠neas detalladas del presupuesto

#### 3.3.4 `impresion_factura_abono.php` ‚≠ê NUEVO

Genera factura rectificativa/abono:
- ‚úÖ T√≠tulo: "FACTURA DE ABONO" en rojo
- ‚úÖ N√∫mero de abono: R2024/0001
- ‚úÖ Destacado: "ABONA LA FACTURA: F2024/0123"
- ‚úÖ Motivo del abono en recuadro amarillo
- ‚úÖ Todos los importes en NEGATIVO y color rojo
- ‚úÖ Datos fiscales completos (empresa + cliente)
- ‚úÖ Total: "TOTAL A DEVOLVER"

---

## 4Ô∏è‚É£ VISTAS (FRONTEND)

### 4.1 Modificar vista principal de presupuesto

**Archivo**: `view/Presupuesto/presupuesto_detalle.php`

A√±adir pesta√±as:
- **Tab Documentos**: Lista de PDFs generados con bot√≥n [Abonar] para facturas normales
- **Tab Pagos**: Historial de pagos con resumen (Total/Pagado/Pendiente)

### 4.2 Modal registrar pago ‚≠ê ACTUALIZADO

**Archivo**: `view/Presupuesto/modal_registrar_pago.php`

Formulario para registrar pagos a cuenta con opci√≥n de generar factura autom√°ticamente.

**Campos del formulario**:
- Tipo de pago (anticipo, total, resto, devoluci√≥n)
- Importe del pago
- Fecha de pago
- M√©todo de pago (efectivo, transferencia, tarjeta, etc.)
- Referencia del pago
- Checkbox: "Generar factura autom√°ticamente"
- **Dropdown: Empresa emisora** (se muestra solo si checkbox "Generar factura" est√° marcado)
  - Carga empresas mediante AJAX desde `pago_presupuesto.php?op=listar_empresas_facturacion`
  - Muestra solo empresas reales (`ficticia_empresa = FALSE`)
  - Campo **obligatorio** si se va a generar factura
  - **RESTRICCI√ìN**: Si ya existe factura emitida, dropdown aparece **DESHABILITADO** con empresa bloqueada
  - Mensaje informativo: "‚ö†Ô∏è Seleccione la empresa real que emitir√° la factura (el presupuesto usa empresa ficticia)"
  - Si empresa bloqueada: "üîí Empresa bloqueada: Ya existe factura emitida con [NOMBRE_EMPRESA]. No se puede cambiar."
- Observaciones

### 4.3 Modal abonar factura ‚≠ê NUEVO

**Archivo**: `view/Presupuesto/modal_abonar_factura.php`

Formulario para abonar facturas con:
- Informaci√≥n de la factura a abonar
- Campo obligatorio: Motivo del abono
- Checkbox de confirmaci√≥n
- Advertencia de anulaci√≥n de pago

### 4.4 JavaScript del m√≥dulo

**Archivo**: `view/Presupuesto/presupuesto_detalle.js`

Funciones principales:
- `generarParteTrabajo()`
- `generarFacturaProforma()`
- `descargarDocumento(id_documento)`
- `abonarFactura(id_documento)` ‚≠ê NUEVA
- `modalRegistrarPago()`
- `guardarPago()`
- `modalAbonarFactura(id_documento)` ‚≠ê NUEVA
- `procesarAbono()` ‚≠ê NUEVA

---

## 5Ô∏è‚É£ FLUJOS DE TRABAJO

### 5.1 Flujo: Generar Parte de Trabajo

1. Usuario presiona [Parte de Trabajo]
2. Controller obtiene datos sin precios
3. Genera HTML y convierte a PDF
4. Registra en `documento_presupuesto` tipo='parte_trabajo'
5. Abre PDF en nueva pesta√±a

### 5.2 Flujo: Generar Factura Proforma

1. Usuario presiona [Factura Proforma]
2. Valida: presupuesto aprobado + no existe factura proforma
3. Genera n√∫mero con `sp_obtener_siguiente_numero('factura_proforma')`
4. Crea PDF con literal "FACTURA PROFORMA"
5. Registra en BD y actualiza contador
6. Descarga PDF

### 5.3 Flujo: Registrar Pago con Factura ‚≠ê ACTUALIZADO

1. Usuario abre modal [Registrar Pago]
2. Sistema verifica si ya existe alguna factura emitida:
   - **SI existe**: Obtiene `id_empresa` de primera factura (empresa bloqueada)
   - **NO existe**: Permitir√° seleccionar empresa
3. Completa: tipo, importe, fecha, m√©todo
4. Si marca checkbox "Generar factura":
   - **4A. Sistema muestra dropdown de selecci√≥n de empresa real**
   - **SI empresa bloqueada**: Dropdown aparece DESHABILITADO con empresa ya seleccionada
   - **SI NO bloqueada**: Carga empresas mediante `sp_listar_empresas_facturacion()` (solo empresas NO ficticias)
   - Usuario **DEBE** seleccionar empresa emisora (o usar la bloqueada)
   - **Validaci√≥n**: NO permitir continuar si no hay empresa
   - **Validaci√≥n**: Rechazar si empresa seleccionada es ficticia (doble check backend)
   - **Validaci√≥n**: Si existe factura previa, validar que `id_empresa` coincida
   - Tipo='total' ‚Üí Factura proforma con empresa seleccionada
   - Tipo='anticipo' ‚Üí Factura anticipo con empresa seleccionada
5. Registra documento con `seleccion_manual_empresa_documento_ppto = TRUE`
6. Registra pago y vincula documento
7. Actualiza resumen de pagos

**Notas importantes**: 
- El presupuesto original usa empresa ficticia, pero **TODA factura (incluso proforma) SIEMPRE usa empresa REAL** seleccionada manualmente para tener validez fiscal
- **Una vez emitida la primera factura, la empresa queda BLOQUEADA** para todas las facturas futuras de ese presupuesto
- Los abonos heredan autom√°ticamente la empresa de la factura que abonan

### 5.4 Flujo: Abonar Factura ‚≠ê NUEVO

1. Usuario ve tabla de documentos
2. Presiona [Abonar] en factura normal (F2024/0123)
3. Sistema valida que puede abonarse
4. Abre modal con datos de factura
5. Usuario introduce **motivo del abono** (obligatorio)
6. Usuario confirma (checkbox + SweetAlert)
7. Controller:
   - Genera n√∫mero de abono: R2024/0001
   - Registra en BD con importes EN NEGATIVO
   - Genera PDF con literal "FACTURA DE ABONO"
   - **Anula autom√°ticamente el pago original**
   - Registra devoluci√≥n (importe negativo)
8. Actualiza tablas y resumen
9. Abre PDF del abono

### 5.5 Flujo: Consultar Estado de Pagos

1. Usuario abre tab [Pagos]
2. Carga historial desde `v_pagos_presupuesto`
3. Muestra tabla con pagos y devoluciones
4. Calcula resumen:
   - Total Presupuesto
   - Total Pagado (suma de pagos NO anulados)
   - Saldo Pendiente
5. Devoluciones se muestran en rojo y negativo

---

## 6Ô∏è‚É£ CONSIDERACIONES T√âCNICAS

### 6.1 Validaciones requeridas

#### Backend (PHP):
- [ ] No permitir pagos superiores al saldo pendiente
- [ ] No permitir duplicar factura proforma
- [ ] Validar presupuesto aprobado antes de facturas
- [ ] **Validar empresa real al generar factura**: Al registrar pago con tipo='anticipo' o 'total', DEVE proporcionarse `id_empresa`
- [ ] **Validar empresa NO ficticia**: Rechazar si `id_empresa` corresponde a empresa con `ficticia_empresa = TRUE`
- [ ] **Campo obligatorio**: `id_empresa` requerido cuando se marca "Generar factura"
- [ ] **‚≠ê VALIDAR empresa bloqueada**: Si ya existe factura emitida, validar que `id_empresa` coincida con primera factura
- [ ] **‚≠ê NO permitir cambio de empresa**: Query para obtener `id_empresa` de primera factura del presupuesto. Si existe, rechazar `id_empresa` diferente
- [ ] **Factura proforma SIEMPRE empresa real**: Validar que factura proforma NO use empresa ficticia (igual que anticipo y normal)
- [ ] **NO permitir abonar facturas proforma** (solo normales)
- [ ] **Validar que factura NO tenga ya un abono**
- [ ] **Validar motivo de abono no vac√≠o** (min 10 caracteres)
- [ ] **Generar importes en negativo en abonos**
- [ ] **Anular pago al generar abono**
- [ ] **Abonos heredan empresa de factura origen** (usar `id_empresa` de factura abonada)

#### Frontend (JS):
- [ ] Validar formato importe
- [ ] Validar fecha pago no futura
- [ ] Calcular porcentaje autom√°ticamente
- [ ] **‚≠ê Verificar empresa bloqueada al abrir modal**: AJAX a `verificar_empresa_disponible`
- [ ] **‚≠ê SI empresa bloqueada**: Cargar empresa en dropdown DESHABILITADO con icono üîí
- [ ] **‚≠ê Mostrar mensaje**: "Empresa bloqueada: Ya existe factura con [NOMBRE]. No se puede cambiar."
- [ ] **SI NO bloqueada**: Mostrar dropdown empresa al marcar "Generar factura" con empresas reales disponibles
- [ ] **Validar empresa seleccionada**: No permitir enviar formulario sin seleccionar empresa si "Generar factura" est√° marcado
- [ ] **Advertencia empresa ficticia**: Mostrar alerta si usuario intenta seleccionar empresa ficticia (aunque no deber√≠a aparecer en lista)
- [ ] **Deshabilitar cambio empresa**: Si empresa bloqueada, campo readonly/disabled
- [ ] **Mostrar bot√≥n [Abonar] SOLO en facturas normales**
- [ ] **Ocultar bot√≥n si factura ya tiene abono**
- [ ] **Doble confirmaci√≥n para abonos** (checkbox + SweetAlert)
- [ ] **Mostrar importes negativos en rojo**

### 6.2 Arquitectura de archivos PDF

```
public/documentos/presupuestos/
‚îú‚îÄ‚îÄ [id_presupuesto]/
‚îÇ   ‚îú‚îÄ‚îÄ presupuesto_P2024-0001.pdf
‚îÇ   ‚îú‚îÄ‚îÄ parte_trabajo_20241215.pdf
‚îÇ   ‚îú‚îÄ‚îÄ factura_proforma_FP2024-0001.pdf
‚îÇ   ‚îú‚îÄ‚îÄ factura_anticipo_F2024-0123.pdf
‚îÇ   ‚îú‚îÄ‚îÄ abono_R2024-0001.pdf  ‚≠ê NUEVO
‚îÇ   ‚îî‚îÄ‚îÄ .htaccess (deny from all)
```

### 6.3 Permisos y roles

- `presupuesto.generar_documentos` - Generar partes/facturas
- `presupuesto.registrar_pagos` - Crear/editar pagos
- `presupuesto.anular_pagos` - Anular pagos
- `presupuesto.generar_abonos` - **Nuevo**: Generar abonos
- `presupuesto.ver_pagos` - Consultar historial

### 6.4 Logs y auditor√≠a

Registrar en `RegistroActividad`:
- Generaci√≥n de factura proforma
- Generaci√≥n de factura de anticipo
- **Generaci√≥n de factura de abono** ‚≠ê
- Registro de pago
- **Anulaci√≥n autom√°tica de pago por abono** ‚≠ê
- Actualizaci√≥n de contadores

### 6.5 Integraci√≥n futura

- ‚úÖ Facturaci√≥n completa
- ‚úÖ **Abonos parciales**
- ‚úÖ Integraci√≥n VeriFactu (incluir abonos)
- ‚úÖ Contabilidad (exportar abonos)
- ‚úÖ **Libro de facturas rectificativas**

---

## 7Ô∏è‚É£ CHECKLIST DE IMPLEMENTACI√ìN

### Fase 1: Base de Datos (2-3 d√≠as)
- [ ] Crear migration add_factura_proforma.sql
- [ ] Crear migration create_documento_presupuesto.sql
- [ ] Crear migration create_pago_presupuesto.sql
- [ ] Modificar sp_obtener_siguiente_numero
- [ ] Modificar sp_actualizar_contador_empresa
- [ ] Crear vista v_documentos_presupuesto
- [ ] Crear vista v_pagos_presupuesto
- [ ] Ejecutar migrations en desarrollo
- [ ] **Verificar serie_abono_empresa en todas las empresas**

### Fase 2: Modelos (2-3 d√≠as)
- [ ] Crear models/DocumentoPresupuesto.php
- [ ] Implementar verificar_puede_abonar()
- [ ] Crear models/PagoPresupuesto.php
- [ ] Implementar anular_pago_por_abono()
- [ ] Modificar models/Empresas.php
- [ ] Tests unitarios

### Fase 3: Controllers (4-5 d√≠as)
- [ ] Crear controller/documento_presupuesto.php
- [ ] Crear controller/pago_presupuesto.php
- [ ] Crear controller/impresion_parte_trabajo.php
- [ ] Crear controller/impresion_factura_proforma.php
- [ ] Crear controller/impresion_factura_anticipo.php
- [ ] **Crear controller/impresion_factura_abono.php** ‚≠ê
- [ ] Validaciones de abonos

### Fase 4: PDFs (3-4 d√≠as)
- [ ] Template HTML parte trabajo
- [ ] Template HTML factura proforma
- [ ] Template HTML factura anticipo
- [ ] **Template HTML factura de abono** ‚≠ê
- [ ] Importes en NEGATIVO en abonos
- [ ] Generaci√≥n PDF (DOMPDF)

### Fase 5: Frontend (4-5 d√≠as)
- [ ] Modificar presupuesto_detalle.php
- [ ] Tab documentos con bot√≥n [Abonar]
- [ ] Tab pagos con resumen
- [ ] modal_registrar_pago.php
- [ ] **modal_abonar_factura.php** ‚≠ê
- [ ] presupuesto_detalle.js
- [ ] Funci√≥n abonarFactura()
- [ ] **CSS importes negativos en rojo**

### Fase 6: Testing (3-4 d√≠as)
- [ ] Test: Generar parte trabajo
- [ ] Test: Generar factura proforma
- [ ] Test: Registrar pago con factura
- [ ] **Test: Abonar factura normal** ‚≠ê
- [ ] **Test: NO abonar factura proforma**
- [ ] **Test: NO abonar factura ya abonada**
- [ ] **Test: Anulaci√≥n autom√°tica de pago**
- [ ] **Test: Importes negativos en abono**
- [ ] Test: Numeraci√≥n correlativa
- [ ] Test: Calcular saldos

### Fase 7: Documentaci√≥n (1-2 d√≠as)
- [ ] Actualizar README.md
- [ ] Manual de usuario
- [ ] **Documentar proceso de abonos**
- [ ] API de controllers
- [ ] **Diagrama de flujo de abonos**

### Fase 8: Deploy (1 d√≠a)
- [ ] Migrations en producci√≥n
- [ ] Actualizar config empresa (series FP)
- [ ] **Verificar series abono en empresas**
- [ ] Crear directorios documentos
- [ ] Backup pre-deploy
- [ ] Desplegar c√≥digo
- [ ] **Probar abono en producci√≥n**

---

## 8Ô∏è‚É£ ESTIMACI√ìN TEMPORAL

| Fase | Duraci√≥n | Notas |
|------|----------|-------|
| **1. Base de Datos** | 3 d√≠as | +1 d√≠a por abonos |
| **2. Modelos** | 3 d√≠as | +1 d√≠a por m√©todos de abonos |
| **3. Controllers** | 5 d√≠as | +1 d√≠a por controller abono |
| **4. PDFs** | 4 d√≠as | +1 d√≠a por template abono |
| **5. Frontend** | 5 d√≠as | +1 d√≠a por modal abono |
| **6. Testing** | 4 d√≠as | +1 d√≠a por tests abonos |
| **7. Documentaci√≥n** | 2 d√≠as | +1 d√≠a por doc abonos |
| **8. Deploy** | 1 d√≠a | - |
| **TOTAL** | **27 d√≠as** | **(‚âà5-6 semanas)** |

---

## 9Ô∏è‚É£ RIESGOS Y MITIGACIONES

| Riesgo | Impacto | Prob | Mitigaci√≥n |
|--------|---------|------|------------|
| Conflicto numeraci√≥n | Alto | Medio | Backup BD + validar unicidad |
| PDFs no generan correctamente | Alto | Bajo | Probar presupuestos reales |
| C√°lculo IVA incorrecto | Medio | Bajo | Reutilizar l√≥gica existente |
| Pagos duplicados | Medio | Medio | Validaci√≥n JS + backend |
| Falta serie factura proforma | Bajo | Alto | Migration con defaults |
| **Abonar factura ya abonada** | Alto | Medio | Validaci√≥n backend + deshabilitar bot√≥n |
| **Importes positivos en abono** | Alto | Bajo | Math.abs() * -1 en controller |
| **No anular pago al abonar** | Alto | Bajo | Transacci√≥n at√≥mica |
| **Motivo abono vac√≠o** | Medio | Medio | Validaci√≥n JS + backend required |
| **‚≠ê Cambiar empresa tras emisi√≥n factura** | Alto | Alto | Query empresa primera factura + validaci√≥n estricta backend |
| **‚≠ê Factura proforma con empresa ficticia** | Alto | Medio | Validaci√≥n backend empresa real (igual que facturas normales) |
| **‚≠ê Usuario fuerza cambio empresa** | Medio | Bajo | Validaci√≥n doble: frontend (disabled) + backend (rechazar) |

---

## üîü NOTAS FINALES

### Compatibilidad con est√°ndares

‚úÖ Cumple con `.github/copilot-instructions.md`:
- Tablas en SINGULAR con sufijos `_tabla`
- Campos obligatorios: `id_`, `activo_`, `created_at_`, `updated_at_`
- Prepared statements
- Soft delete
- Logging con RegistroActividad
- Zona horaria Europe/Madrid

### Puntos de extensi√≥n futura

1. **Facturaci√≥n completa**: tipo `factura_final`
2. **Abonos parciales**: Abonar solo parte del importe
3. **Albaranes**: Nuevo tipo vinculado a elementos
4. **Contabilidad**: Exportar a SAGE/A3
5. **VeriFactu**: Integraci√≥n AEAT (incluir abonos)
6. **Conciliaci√≥n bancaria**: Vincular extractos
7. **Libro de facturas rectificativas**: Informe de abonos

### Decisiones t√©cnicas clave sobre ABONOS

1. **Solo facturas normales**: NO se abonan facturas proforma
2. **Un abono por factura**: Una factura = UN abono (no m√∫ltiples en v1)
3. **Anulaci√≥n autom√°tica**: Al generar abono, pago se anula autom√°ticamente
4. **Importes negativos**: Abonos SIEMPRE negativos (validaci√≥n estricta)
5. **Motivo obligatorio**: Aparece en PDF
6. **Doble confirmaci√≥n**: Checkbox + SweetAlert
7. **Auditor√≠a completa**: RegistroActividad

### Decisiones t√©cnicas clave sobre EMPRESAS REALES

1. **Presupuestos con empresa ficticia**: Presupuestos y partes trabajo usan empresa ficticia principal
2. **TODAS las facturas con empresa real**: Factura proforma, anticipo y normal SIEMPRE requieren empresa REAL (no ficticia)
3. **Selecci√≥n manual obligatoria**: Usuario DEBE seleccionar empresa real al emitir primera factura de un presupuesto
4. **Empresa bloqueada tras primera factura**: Una vez emitida cualquier factura (proforma, anticipo, normal), la empresa queda BLOQUEADA para ese presupuesto
5. **No cambiar empresa**: NO se permite cambiar de empresa tras emitir factura (validaci√≥n frontend disabled + backend rechaza)
6. **Abonos heredan empresa**: Los abonos usan autom√°ticamente la `id_empresa` de la factura que abonan
7. **Validaci√≥n doble**: Frontend deshabilita campo si empresa bloqueada + Backend valida coincidencia con primera factura
8. **Query empresa bloqueada**: `SELECT id_empresa FROM documento_presupuesto WHERE id_presupuesto = ? AND tipo_documento_ppto IN ('factura_proforma','factura_anticipo','factura_normal') LIMIT 1`

### Referencias t√©cnicas

- Modelo presupuestos: `models/Presupuesto.php`
- Impresi√≥n actual: `controller/impresionpresupuesto_m1_es.php`
- SP numeraci√≥n: `BD/toldos_db(2).sql` l√≠neas 30-140
- Tabla empresa: `BD/toldos_db(2).sql` l√≠neas 1036-1140
- **Serie abonos existente**: `serie_abono_empresa` y `numero_actual_abono_empresa`

---

**Estado**: ‚úÖ Plan completo y listo para implementar

**Revisi√≥n**: 16 de febrero de 2026

**Pr√≥ximos pasos**:
1. Crear migrations en BD
2. Implementar modelos DocumentoPresupuesto y PagoPresupuesto
3. Desarrollar controllers de impresi√≥n
4. Dise√±ar templates PDF
5. Crear interfaces frontend
6. Testing exhaustivo
7. Documentaci√≥n
8. Deploy en producci√≥n

---

**RESUMEN**: Sistema completo de pagos, facturas proforma, facturas de anticipo y abonos/rectificativas para presupuestos aprobados, con tracking completo en base de datos, generaci√≥n automatizada de PDFs y gesti√≥n de numeraci√≥n correlativa.
